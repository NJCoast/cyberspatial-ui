{% extends 'site_base.html' %}
{% load i18n %}
{% load staticfiles %}
{% load base_tags %}

{% block body_class %}home{% endblock %}

{% block extra_head %}
    <link rel="stylesheet" type="text/css" href="{% static "css/fontawesome-all.min.css" %}" media="screen" />
    <link rel="stylesheet" type="text/css" href="{% static "css/njcoast-admin-style.css" %}" media="screen" />
{% endblock extra_head %}

{% block middle %}
<div class="jumbotron njcoast-image slimmer"></div>

<div class="gray-zone">
    <div class="container-fluid">
        <div class="page-header" style="border: none">
            <!--<a href="admin-dca-change.html" class="btn btn-primary btn-md pull-right">Edit DCA Approvers</a>-->
            <h3>DCA Administrator Controls</h3>
        </div>

        <ul class="nav nav-tabs nav-justified admin-tabs">
            <li id="tab_1" onclick="flip_tabs(this.id);" class="active"><a href="#"><span class="fa fa-user-circle"></span> Municipal Approvers</a></li>
            <li id="tab_2" onclick="flip_tabs(this.id);"><a href="#"><span class="fa fa-users"></span> All NJcoast Users</a></li>
            <li id="tab_3" onclick="flip_tabs(this.id);"><a href="#"><span class="fa fa-exclamation-circle"></span> Account Requests</a></li>
        </ul>

        <!-- municipalities code ---------------------------------------------->
        <div id="data_1">
            <div class="filter-bkgrnd">

                <div class="row">
                    <div class="col-sm-4">

                        <span class="f-label">Filters:</span>

                        <div class="btn-group">
                            <button type="button" class="btn btn-default dropdown-toggle"
                                data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
                                    County <span class="caret"></span>
                                        </button>
                            <ul class="dropdown-menu">
                                {% for county in counties %}
                                <li><a href="#">{{ county.name }}</a></li>
                                {% endfor %}
                            </ul>
                        </div>

                    </div>
                    <div class="col-sm-8">

                        <div class="input-group">
                            <input type="text" class="form-control" placeholder="Search table for...">
                            <span class="input-group-btn">
                                <button class="btn btn-default" type="button">
                                    <span class="fa fa-search"></span></button>
                            </span>
                        </div>
                        <!-- /input-group -->

                    </div>
                </div>

            </div>

            <div class="table-bkgrnd">

                <table class="table table-hover admin">
                    <tbody>
                        <tr>
                            <th>Code <span class="fa fa-sort"></span></th>
                            <th>Municipality <span class="fa fa-sort"></span></th>
                            <th>Name <span class="fa fa-sort"></span></th>
                            <th>Position <span class="fa fa-sort"></span></th>
                            <th>Email</th>
                            <th>Notes</th>
                            <th</th>
                        </tr>
                        {% for muni_admin in muni_admins %}
                        <tr>
                            <td>{{ muni_admin.njcusermeta.municipality.code }}</td>
                            <td>{{ muni_admin.njcusermeta.municipality }}</td>
                            <td>{{ muni_admin.first_name }} {{ muni_admin.last_name }}</td>
                            <td class="position">{{ muni_admin.njcusermeta.position }}</td>
                            <td><a>{{ muni_admin.email }}</a></td>
                            <td class="notes">{{ muni_admin.njcusermeta.notes }}</td>
                            <td><a onclick="view_user_info('{{ muni_admin.username  }}', 1, 'Return to Municipal Approvers list');" href="#"><span class="fa fa-info-circle"></span></a></td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>

            </div>
        </div>
        <!-- END munivcipalities code ----------------------------------------->

        <!-- njcoast users ---------------------------------------------------->
        <div id="data_2" class="hidden">
            <div class="filter-bkgrnd">
                <div class="row">
                    <div class="col-sm-8">

                        <ul class="selected">
                            <li>Your selection:</li>
                            <li>Berkeley Twp <span class="fa fa-times"></span></li>
                        </ul>

                    </div>
                    <div class="col-sm-4">

                        <div class="input-group">
                            <input type="text" class="form-control" placeholder="Search table for...">
                            <span class="input-group-btn">
                  <button class="btn btn-default" type="button"><span class="fa fa-search"></span></button>
                            </span>
                        </div>
                        <!-- /input-group -->

                    </div>
                </div>

            </div>

            <div class="table-bkgrnd">

                <div class="row">
                    <div class="col-sm-2">

                        <ul class="user-filters">
                            <li>Status <span class="fa fa-chevron-down pull-right"></span></li>
                            <ul>
                                <li><input type="checkbox"> Pending</li>
                                <li><input type="checkbox"> Active</li>
                                <li><input type="checkbox"> Inactive</li>
                            </ul>
                            <li>County <span class="fa fa-chevron-right pull-right"></span></li>
                            <li>Municipality <span class="fa fa-chevron-right pull-right"></span></li>
                            <li>Role <span class="fa fa-chevron-right pull-right"></span></li>
                        </ul>

                    </div>

                    <div class="col-sm-10">
                        <table class="table table-hover admin-user">
                            <tbody>
                                <tr>
                                    <th>Name <span class="fa fa-sort"></span></th>
                                    <th>Email</th>
                                    <th>Role <span class="fa fa-sort"></span></th>
                                    <th>Municipality <span class="fa fa-sort"></span></th>
                                    <th>Status</th>
                                    <th>Notes</th>
                                    <th></th>
                                </tr>
                                {% for user in users %}
                                <tr>
                                    <td>{{ user.first_name }} {{ user.last_name }}</td>
                                    <td><a>{{ user.email }}</a></td>
                                    <td>{{ user.njcusermeta.role }}</td>
                                    <td>{{ user.njcusermeta.municipality }}</td>
                                    {% if user.is_active %}
                                    <td class="status act">active</td>
                                    <td class="notes">{{ user.njcusermeta.notes }}</td>
                                    <td><a onclick="view_user_info('{{ user.username }}', 2, 'Return to All NJcoast Users list');" href="#"><span class="fa fa-info-circle"></span></a></td>
                                    {% else %}
                                        {% if user.njcusermeta.is_dca_approved %}
                                    <td class="status inact">inactive</td>
                                    <td class="notes">{{ user.njcusermeta.notes }}</td>
                                    <td><a onclick="view_user_info('{{ user.username }}', 2, 'Return to All NJcoast Users list');" href="#"><span class="fa fa-info-circle"></span></a></td>
                                        {% else %}
                                    <td class="status pnd">pending</td>
                                    <td><a onclick="flip_tabs('tab_3');" href="#" class="btn btn-warning btn-sm btn-block">View Request</a></td>
                                        {% endif %}
                                    {% endif %}
                                    <td></td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>

                </div>

            </div>
        </div>
        <!-- END njcoast users ------------------------------------------------>

        <!-- account requests ------------------------------------------------->
        <div id="data_3" class="hidden">
            <div class="filter-bkgrnd">
                <i><span class="fa fa-exclamation-circle"></span> {{ number_to_be_approved }} pending requests</i>
            </div>

            <div class="table-bkgrnd">
                {% for user in users %}
                    {% if user.is_active %}
                    {% else %}
                        {% if user.njcusermeta.is_dca_approved %}
                        {% else %}
                <div class="row review-request">
                    <div class="col-md-5 col-lg-4">
                        <div class="well">
                            <table class="table">
                                <tbody>
                                    <tr>
                                        <th style="border-top: 0">Name</th>
                                        <td style="border-top: 0">{{ user.first_name }} {{ user.last_name }}</td>
                                    </tr>
                                    <tr>
                                        <th>Title</th>
                                        <td>{{ user.njcusermeta.position }}</td>
                                    </tr>
                                    <tr>
                                        <th>Municipality</th>
                                        <td>{{ user.njcusermeta.municipality }}</td>
                                    </tr>
                                    <tr>
                                        <th>Role</th>
                                        <td id="role_{{ forloop.counter }}" >{{ user.njcusermeta.role }}</td>
                                    </tr>
                                </tbody>
                            </table>
                            <p><b>Justification:</b>{{ user.njcusermeta.justification }}</p>
                        </div>
                    </div>
                    <div class="col-md-7 col-lg-8">
                        <p class="qualifier" style="margin-top: 10px;">Received: {{ user.date_joined }}; Muni Approval: {{ user.muni_approval_date }}</p>
                        <textarea id="text_{{ forloop.counter }}" class="form-control" placeholder="" rows="7">{{ user.njcusermeta.notes }}</textarea>
                        <div class="btn-group">
                            <button type="button" class="btn btn-default dropdown-toggle"
                                data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
                                    Change Role <span class="caret"></span>
                                        </button>
                            <ul class="dropdown-menu">
                                {% for role in roles %}
                                <li><a onclick="user_update('{{ user.username }}', '{{ forloop.parentloop.counter }}', 'update_role', '{{ role.name }}');" href="#">{{ role.name }}</a></li>
                                {% endfor %}
                            </ul>
                        </div>
                        <button onclick="user_update('{{ user.username }}', '{{ forloop.counter }}', 'approve', '');" class="btn btn-primary" data-toggle="modal" data-target="">Approve</button>
                        <button onclick="user_update('{{ user.username }}', '{{ forloop.counter }}', 'decline', '');" class="btn btn-default" data-toggle="modal" data-target="">Decline*</button>
                        <p class="qualifier" style="margin-top: 10px;">*Any notes entered for a Declined applicant will be shared with the applicant to justify the decision.</p>
                    </div>
                </div>
                <hr/>
                        {% endif %}
                    {% endif %}
                {% endfor %}

            </div>
        </div>
        <!-- END account requests --------------------------------------------->

        <!-- account info ----------------------------------------------------->
        <div id="data_4" class="hidden">
            <div id="navigation_4" class="return-to-list">
                <a id="navigation_4" onclick="view_user_info('', 2, '');" href="#"><span class="fa fa-chevron-left"></span> Return to All NJcoast Users list</a>
            </div>

            <!--User data presented-------------------------------------------->
            <div id="info_user" class="table-bkgrnd">

                <div class="row">
                    <div class="col-sm-3">
                        <div class="lg-list-identifier ">
                            <span class="fa fa-users fa-5x "></span>
                            <p>NJcoast User Profile</p>
                        </div>
                    </div>
                    <div class="col-sm-9">

                        <table class="table">
                            <tbody>
                                <tr>
                                    <th style="border-top: 0">Full Name</th>
                                    <td id="info_name" style="border-top: 0">Sarah Jones</td>
                                </tr>
                                <tr>
                                    <th>Position/Title</th>
                                    <td id="info_position">Planner</td>
                                </tr>
                                <tr>
                                    <th>Municipality Name</th>
                                    <td id="info_municipality">Berkeley Twp</td>
                                </tr>
                                <tr>
                                    <th>Municipality Code</th>
                                    <td id="info_code">1506</td>
                                </tr>
                                <tr>
                                    <!--<tr>
                                        <th>Mailing address</th>
                                        <td>627 Pinewald-Keswick Rd<br/>Bayville, NJ 08721</td>
                                    </tr>-->
                                    <th>Email</th>
                                    <td><a id="info_email">sjones@gmail.com</a></td>
                                </tr>
                                <tr>
                                    <th>Phone</th>
                                    <td id="info_voice">732-341-1132</td>
                                </tr>
                                <tr>
                                    <th>Role</th>
                                    <td id="info_role">PL - Planning</td>
                                </tr>
                                <tr>
                                    <th>Justification</th>
                                    <td id="info_justification">I am involved in planning for Berkeley, and need the tool for storm projection.</td>
                                </tr>
                            </tbody>
                        </table>
                        <a onclick="show_user_edit(true);" href="#" class="btn btn-primary">Edit</a>
                        <button type="button" class="btn btn-default" data-toggle="modal" data-target="#myModal">
                                          Delete
                                        </button>
                    </div>
                </div>

                <!-- Modal -->
                <div class="modal fade" id="myModal" tabindex="-1" role="dialog" aria-labelledby="myModalLabel">
                    <div class="modal-dialog" role="document">
                        <div class="modal-content">
                            <div class="modal-header">
                                <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
                                <h4 class="modal-title" id="myModalLabel">Delete NJcoast User Profile</h4>
                            </div>
                            <div class="modal-body">
                                Are you sure you would like to delete this NJcoast user profile?
                            </div>
                            <div class="modal-footer">
                                <a onclick="delete_user(document.getElementById('edit_username').innerHTML);" class="btn btn-primary" href="#">Yes</a>
                                <a onclick="$('#myModal').modal('hide');" class="btn btn-default" href="#">No</a>
                            </div>
                        </div>
                    </div>
                </div>

            </div>
            <!--END of data presented------------------------------------------>

            <!--Editable version----------------------------------------------->
            <div id="editable_user" class="table-bkgrnd hidden">

                <div class="row">
                    <div class="col-sm-3"> <!-- col-md-6 "-->
                            <div class="lg-list-identifier ">
                              <span class="fa fa-users fa-5x "></span>
                              <p>NJcoast User Profile</p>
                            </div>
                          </div>
                          <div class="col-sm-9 "> <!-- col-md-6"-->

                        <table class="table edit-profile">
                            <tbody>
                                <tr>
                                    <th style="border-top: 0">Full Name</th>
                                    <td style="border-top: 0"><input type="text" class="form-control" id="edit_name" value="Sarah Jones"></td>
                                </tr>
                                <tr>
                                    <th>Position/Title</th>
                                    <td><input type="text" class="form-control" id="edit_position" value="Planner"></td>
                                </tr>
                                <tr>
                                    <th>Municipality Name</th>
                                    <!--<td><input type="text" class="form-control" id="edit_municipality" value="Berkeley Twp"></td>-->
                                    <td>
                                        <select id="edit_municipality_selector" onchange="set_municipality_code(this.value);" class="form-control">
                                            {% for municipality in municipalities %}
                                            <option value="{{ municipality.code }}">{{ municipality.name }}</option>
                                            {% endfor %}
                                        </select>
                                    </td>

                                </tr>
                                <tr>
                                    <th>Municipality Code</th>
                                    <!-- Should auto-update when Municipality changes -->
                                    <td id="edit_code" style="color:#999">1506</td>
                                </tr>
                                <tr>
                                    <th>Mailing address</th>
                                    <td>
                                        <input type="text" class="form-control" id="edit_address_line_1" value="627 Pinewald-Keswick Rd">
                                        <input type="text" class="form-control" id="edit_address_line_2" placeholder="Address line 2">
                                        <input type="text" class="form-control" id="edit_city" value="Bayville">
                                        <input type="text" class="form-control" id="edit_zip" value="08721">
                                    </td>
                                </tr>
                                <tr>
                                    <th>Email</th>
                                    <td><input type="email" class="form-control" id="edit_email" value="sjones@gmail.com"></td>
                                </tr>
                                <tr>
                                    <th>Phone</th>
                                    <td><input type="tel" class="form-control" id="edit_voice" value="732-341-1132"></td>
                                </tr>
                                <tr>
                                    <th>Role</th>
                                    <td>
                                        <select id="edit_role_selector" class="form-control">
                                            {% for role in roles %}
                                            <option value="{{ role.name }}">{{ role.name }}</option>
                                            {% endfor %}
                                        </select>
                                    </td>
                                </tr>
                                <tr>
                                    <th>Justification</th>
                                    <td id="edit_justification" style="color:#999">I am involved in planning for Berkeley, and need the tool for storm projection.</td>
                                </tr>
                            </tbody>
                        </table>
                        <div class="hidden" id="edit_username"></div>

                        <button type="button" class="btn btn-primary" data-toggle="modal" data-target="#saveChanges-1">
                              Save changes
                            </button>
                        <a onclick="show_user_edit(false);" href="#" class="btn btn-default">Cancel</a>


                        <!-- Modal - Save changes button -->
                        <div class="modal fade" id="saveChanges-1" tabindex="-1" role="dialog" aria-labelledby="saveChanges">
                            <div class="modal-dialog" role="document">
                                <div class="modal-content">
                                    <div class="modal-header">
                                        <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
                                        <h4 class="modal-title" id="saveChanges">Save changes</h4>
                                    </div>
                                    <div class="modal-body">
                                        You have made changes to this NJcoast user profile. Would you like to save these changes?
                                    </div>
                                    <div class="modal-footer">
                                        <a onclick="save_changes(document.getElementById('edit_username').innerHTML);" class="btn btn-primary" href="#">Yes</a>
                                        <a onclick="$('#saveChanges-1').modal('hide');" class="btn btn-default" href="#">No</a>
                                    </div>
                                </div>
                            </div>
                        </div>

                    </div>
                </div>
            </div>
            <!--END Editable version------------------------------------------->

        </div>
        <!-- END account info ------------------------------------------------->

    </div>
</div>
{% endblock %}

{% block extra_script %}
<script src="{% static 'js/notify.min.js' %}"></script>

<script type=text/javascript>
//set muni code after selecting
function set_municipality_code(code){
    console.log(code);
    document.getElementById("edit_code").innerHTML = code;
}

//delete user data
function delete_user(username){
    //fade out modal
    $("#myModal").modal("hide");
    console.log(username);
}

//save user data
function save_changes(username){
    console.log(username);

    //do Ajax call
    $.ajax({
        type: "POST",
        url: "/user/settings/",
        data: {
            'position': document.getElementById("edit_position").value,
            'name': document.getElementById("edit_name").value,
            'email': document.getElementById("edit_email").value,
            'voice': document.getElementById("edit_voice").value,
            'role': document.getElementById("edit_role_selector").
                        options[document.getElementById("edit_role_selector").selectedIndex].text,
            'municipality': document.getElementById("edit_municipality_selector").
                        options[document.getElementById("edit_municipality_selector").selectedIndex].text,
            'address_line_1': document.getElementById("edit_address_line_1").value,
            'address_line_2': document.getElementById("edit_address_line_2").value,
            'city': document.getElementById("edit_city").value,
            'zip': document.getElementById("edit_zip").value,
            'user': username,
            'action': 'update_all'
        },
        dataType: "json",
        success: function(result) {
            console.log("USER APPROVAL -- SUCCESS!" + result.updated);

            if(result.updated){
                //fade out modal
                $("#saveChanges-1").modal("hide");

                //flip back to view
                document.getElementById("info_user").classList.remove("hidden");
                document.getElementById("editable_user").classList.add("hidden");

                //reload view
                view_user_info(username, 2, "Return to All NJcoast Users list");

                //flag success
                $.notify("User updated", "success");
            }else{
                //or failure
                $.notify("Error updating user", "error");
            }
        },
        error: function(result) {
            console.log("ERROR:", result)
            $.notify("Error updating user", "error");
        }
    });

}

//user editing
function show_user_edit(do_edit){
    //flip pages
    if(do_edit){
        document.getElementById("info_user").classList.add("hidden");
        document.getElementById("editable_user").classList.remove("hidden");
    }else{
        document.getElementById("info_user").classList.remove("hidden");
        document.getElementById("editable_user").classList.add("hidden");
    }
}

//user approvals
function user_update(username, user_number, action, role){
    //update role if required
    if(action == 'update_role'){
        document.getElementById("role_"+user_number).innerHTML = role;
    }

    //do Ajax call
    $.ajax({
        type: "POST",
        url: "/user/settings/",
        data: {
            'role': role,
            'notes': document.getElementById("text_"+user_number).value,
            'user': username,
            'action': action
        },
        dataType: "json",
        success: function(result) {
            console.log("USER APPROVAL -- SUCCESS!" + result.updated);

            if(result.updated){
                //flag success
                $.notify("User updated", "success");
            }else{
                //or failure
                $.notify("Error updating user", "error");
            }
        },
        error: function(result) {
            console.log("ERROR:", result)
            $.notify("Error updating user", "error");
        }
    });

}

//view user info
function view_user_info(username, tab_to_return_to, return_text){
    console.log("data "+username);
    if(username != ""){
        //do Ajax call
        $.ajax({
            type: "GET",
            url: "/user/settings/",
            data: {
                'user': username,
                'action': 'get_user'
            },
            dataType: "json",
            success: function(result) {
                console.log("USER APPROVAL -- SUCCESS!" + result.updated);

                if(result.updated){
                    console.log(result.data+","+result.data.name);
                    //put data into html
                    for(user_var in result.data){
                        //info form
                        try {
                            elmt = document.getElementById("info_"+user_var);
                            elmt.innerHTML = result.data[user_var];
                        }
                        catch(err) {
                        }

                        //edit form
                        try {
                            elmt = document.getElementById("edit_"+user_var);
                            if(elmt.nodeName == "INPUT"){
                                elmt.value = result.data[user_var];
                            }else{
                                elmt.innerHTML = result.data[user_var];
                            }
                        }
                        catch(err) {
                        }

                        //set edit selector for role
                        selctr = document.getElementById("edit_role_selector");
                        for(i=0; i<selctr.options.length; i++){
                            if(result.data.role == selctr.options[i].text){
                                selctr.value = result.data.role;
                            }
                        }

                        //set edit selector for municipality
                        selctr = document.getElementById("edit_municipality_selector");
                        for(i=0; i<selctr.options.length; i++){
                            if(result.data.municipality == selctr.options[i].text){
                                selctr.value = result.data.code;
                            }
                        }

                        //flip pages
                        document.getElementById("data_4").classList.remove("hidden");
                        document.getElementById("data_"+tab_to_return_to).classList.add("hidden");

                        //set return link
                        document.getElementById("navigation_4").innerHTML = "<a onclick=\"view_user_info('', "+tab_to_return_to+", '');\" href=\"#\"><span class=\"fa fa-chevron-left\"></span> "+return_text;
                        //console.log("variable "+user_var+","+result.data[user_var]);
                    }
                }else{
                    //or failure
                    console.log("Error retrieving user");
                }
            },
            error: function(result) {
                console.log("Error retrieving user!");
            }
        });
    }else{
        //flip pages back
        document.getElementById("data_"+tab_to_return_to).classList.remove("hidden");
        document.getElementById("data_4").classList.add("hidden");

        //flip out of edit if editing
        show_user_edit(false);
    }
}

//flip the tabs and their data
function flip_tabs(id){
    //hide user info if open
    document.getElementById("data_4").classList.add("hidden");

    //clear Active and set new
    for(i=1; i<=3; i++){
        //remove active
        if("tab_"+i != id){
            document.getElementById("tab_"+i).classList.remove("active");
            document.getElementById("data_"+i).classList.add("hidden");
        }else{ //add active
            document.getElementById(id).classList.add("active");
            document.getElementById("data_"+i).classList.remove("hidden");
        }
    }

    //print
    console.log("Clicked "+id);
}

</script>
{% endblock extra_script %}
