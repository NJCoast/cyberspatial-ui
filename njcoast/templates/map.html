{% extends 'site_base.html' %}
{% load i18n %}
{% load staticfiles %}
{% load base_tags %}

{% block body_class %}home{% endblock %}

{% block extra_head %}
    <!-- Load Leaflet from CDN -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.2.0/dist/leaflet.css"
          integrity="sha512-M2wvCLH6DSRazYeZRIm1JnYyh22purTM+FDB5CsyxtQJYeKq83arPe5wgbNmcFXGqiSH2XR8dT/fJISVA1r/zQ=="
          crossorigin=""/>
    <script src="https://unpkg.com/leaflet@1.2.0/dist/leaflet.js"
            integrity="sha512-lInM/apFSqyy1o6s89K4iQUKg6ppXEgsVxT35HbzUupEVRh2Eu9Wdl4tHj7dZO0s1uvplcYGmt3498TtHq+log=="
            crossorigin=""></script>


    <!-- Load Esri Leaflet from CDN -->
    <script src="https://unpkg.com/esri-leaflet@2.1.1/dist/esri-leaflet.js"
            integrity="sha512-ECQqaYZke9cSdqlFG08zSkudgrdF6I1d8ViSa7I3VIszJyVqw4ng1G8sehEXlumdMnFYfzY0tMgdQa4WCs9IUw=="
            crossorigin=""></script>

    <script src="https://npmcdn.com/leaflet.path.drag/src/Path.Drag.js"></script>

    <!-- Load Leaflet Editable code -->
    <script src="{% static "js/Leaflet.Editable.js" %}"></script>-->

    <!-- load mods to leaflet for rectangular popups -->
    <link rel="stylesheet" type="text/css" href="{% static "css/crc_leaflet.css" %}" media="screen" />

{% endblock extra_head %}


{% block middle %}

<div class="jumbotron njcoast-image slimmer"></div>

<div class="container-fluid">
    <div class="page-header map-header">
        <!--<p>keansburg <span>|</span> planning</p> -->
        <!-- <div id="leaflet-map-menu">
            <div class="dropdown show title-drop pull-right">
                <a class="btn btn-title dropdown-toggle" id="dropdownMenuButton" data-toggle="dropdown"
                   aria-haspopup="true" aria-expanded="false">
                    Standard Planning Map <i class="fa fa-caret-down" style="margin-left: 10px"
                                             aria-hidden="true"></i>
                </a>
                <div class="dropdown-menu" aria-labelledby="dropdownMenuButton">
                    <a class="dropdown-item" href="#">My Custom Map #1</a>
                    <a class="dropdown-item" href="#">Smith's Planning Map</a>
                    <a class="dropdown-item" href="#">Hurricane Jose Map - Annotated</a>
                    <div class="dropdown-divider"></div>
                    <a class="dropdown-item" href="#">Browse All Maps</a>
                </div>
            </div>
            <img class="img-responsive" src="{% static 'images/map-page-icons.png' %}"/>
        </div>-->
    </div>
    <div class="row">

        <div class="col-sm-8 col-lg-9 col-xl-10 leaflet-map">
            <div id="mapid" class="col-sm-8 col-lg-9 col-xl-10" style="width: 100%; height: 100%;"></div>
        </div>
        <div class="col-sm-4 col-lg-3 col-xl-2" id="map-control-panel">
            <div class="map-control-item">

    <a data-toggle="collapse" href="#gisLayers" aria-expanded="false" aria-controls="gisLayers">
        <h4 class="map-control-item-heading">GIS Layers
            <i class="fa fa-chevron-down pull-right" aria-hidden="true"></i></h4>
        <p class="qualifier" style="margin-bottom: 0">for Planning role</p>
    </a>
    <div class="collapse in" id="gisLayers">
        <div id="layerGroup" class="hidden">
            <p class="map-layer-group-heading">
                <a data-toggle="collapse" href="" aria-expanded="false"
                   aria-controls="">
                    <i class="fa fa-chevron-right" aria-hidden="true"></i>
                    <span></span>
                </a>
            </p>
            <ul class="collapse map-layers" id=""></ul>
    </div>
    </div>
                    </div>
                    <div class="map-control-item">
                        {% include 'storm_visualization_menu.html' %}
                    </div>

                    <div class="map-control-item">
                        <a data-toggle="collapse" href="#annotations" aria-expanded="false" aria-controls="annotations">
                            <h4 class="map-control-item-heading">Annotations<i class="fa fa-chevron-down pull-right"
                                                                               aria-hidden="true"></i></h4>
                            <p class="qualifier" style="margin-bottom: 0">write or draw on the map</p>
                        </a>
                        <div class="collapse" id="annotations">
                            <!--Checkbox to toggle annotation layer and functions-->
                            <p style="margin-top: 15px"><input type="checkbox" name="annotations" value="on"
                               data-toggle="popover" data-placement="right" onclick="toggle_annotation_layer(this.checked)" checked> Annotation layer</p>
                               <p style="margin-top: 15px"><input type="checkbox" name="annotate" id="annotate" value="on"
                                  data-toggle="popover" data-placement="right" onclick="toggle_annotate(this.checked)"> Annotate</p>
                                  <div class="beta-feature-not-available"><a class="btn btn-secondary btn-md btn-block" data-toggle="popover" href="#annotationTools"
                                      aria-expanded="false" aria-controls="annotationTools">Edit Annotations</a></div>
                                      <div class="collapse" id="annotationTools">
                                <div class="placeholder-box">
                                    <p>Text and drawing tools go here</p>
                                </div>
                                <button class="btn btn-primary btn-md btn-block" style="margin-top: 20px">Save Changes
                                </button>
                                <button class="btn btn-secondary btn-md btn-block">Clear</button>
                            </div>
                        </div>
                    </div>

                    <div class="map-control-item">
                        <p class="qualifier" style="margin-top: 10px">Save current map configuration (e.g. active layers and
                            annotations), copy the map and save with a new name, or download the map.</p>
                        <div class="beta-feature-not-available"><button disabled class="btn btn-primary btn-md btn-block" data-toggle="popover" data-target="">Save Map
                        </button></div>
                        <div class="beta-feature-not-available"><button disabled class="btn btn-secondary btn-md btn-block" data-toggle="popover" data-target="">Copy Map
                        </button></div>
                        <div class="beta-feature-not-available"><button disabled class="btn btn-secondary btn-md btn-block" data-toggle="popover" data-target="">Download Map
                        </button></div>
                        <div class="beta-feature-not-available"><button disabled class="btn btn-secondary btn-md btn-block" data-toggle="popover" data-target="">Share Map
                        </button></div>
                    </div>
                </div>

            </div>
        </div>

                    {% endblock middle %}


{% block extra_script %}
<script src="{% static 'js/utilities.js' %}"></script>
    <script type=text/javascript>
        var socket;

        /*
        Base Map -- Centered on Keansburg, NJ
        WMS Tile Layers
        Data: Watershed Boundary Dataset - National Hydrography Overlay Map Service
              https://catalog.data.gov/dataset/usgs-national-watershed-boundary-dataset-wbd-
              downloadable-data-collection-national-geospatial-/resource/f55f881d-9de8-471f-9b6b-22cd7a98025d
        XML: https://services.nationalmap.gov/arcgis/services/nhd/MapServer/WMSServer?request=GetCapabilities&service=WMS
         */
        var mymap = L.map('mapid', {editable: true}).setView([{{ home_latitude }}, {{ home_longitude }}], {{ zoom_level }});
        var layer_list = [];
        var layer_groups = [];

        //~~~~create layer group to add marker~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
        var annotationLayer = new L.LayerGroup();
        mymap.editTools.featuresLayer = annotationLayer;

        //~~~~annotate controls~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
        L.EditControl = L.Control.extend({

                options: {
                    position: 'topleft',
                    callback: null,
                    kind: '',
                    html: ''
                },

                onAdd: function (map) {
                    var container = L.DomUtil.create('div', 'leaflet-control leaflet-bar'),
                        link = L.DomUtil.create('a', '', container);

                    link.href = '#';
                    link.title = 'Create a new ' + this.options.kind;
                    link.innerHTML = this.options.html;
                    L.DomEvent.on(link, 'click', L.DomEvent.stop)
                              .on(link, 'click', function () {
                                window.LAYER = this.options.callback.call(map.editTools);
                              }, this);

                    return container;
                }

            });

            L.NewLineControl = L.EditControl.extend({

                options: {
                    position: 'topleft',
                    callback: mymap.editTools.startPolyline,
                    kind: 'line',
                    html: '\\/\\'
                }

            });

            L.NewPolygonControl = L.EditControl.extend({

                options: {
                    position: 'topleft',
                    callback: mymap.editTools.startPolygon,
                    kind: 'polygon',
                    html: 'â–°'
                }

            });

            L.NewMarkerControl = L.EditControl.extend({

                options: {
                    position: 'topleft',
                    callback: mymap.editTools.startMarker,
                    kind: 'marker',
                    html: 'ðŸ–ˆ'
                }

            });

            L.NewRectangleControl = L.EditControl.extend({

                options: {
                    position: 'topleft',
                    callback: mymap.editTools.startRectangle,
                    kind: 'rectangle',
                    html: 'â¬›'
                }

            });

            L.NewCircleControl = L.EditControl.extend({

                options: {
                    position: 'topleft',
                    callback: mymap.editTools.startCircle,
                    kind: 'circle',
                    html: 'â¬¤'
                }

            });

            var marker_control = new L.NewMarkerControl();
            var line_control = new L.NewLineControl();
            var polygon_control = new L.NewPolygonControl();
            var rectangle_control = new L.NewRectangleControl();
            var circle_control = new L.NewCircleControl();

            //~~~~popup editor scheme~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
            //html for popup
            var html1 = "<span style=\"display:block;\" id=\"txt\">";
            var html2 = "</span><input onchange=\"finishedEdit()\" id=\"txtB\" type=\"text\" value=\"";
            var html3 = "\" style=\"display:none;\" size=\"";
            var html4 = "\"/><button class=\"btn btn-primary btn-xs btn-block\" onclick=\"myFunction()\">Edit</button>";

            //current marker
            var current_popup_marker = null;
            var current_popup = null;

            //get the current popup for update
            mymap.on('popupopen', function(e) {
                console.log("popup open");
                current_popup = e.popup;
                current_popup_marker = e.popup._source;
            });

            //functions called from popup html
            function myFunction(){
                document.getElementById("txtB").style.display = "block";
                document.getElementById("txt").style.display = "none";
                current_popup._updateLayout();
            }

            function finishedEdit(){
                document.getElementById("txtB").style.display = "none";
                document.getElementById("txt").style.display = "block";
                document.getElementById("txt").innerHTML = document.getElementById("txtB").value;

                //force new content
                current_popup_marker.setPopupContent(html1 + document.getElementById("txtB").value
                    + html2 + document.getElementById("txtB").value + html3
                        + document.getElementById("txtB").value.length + html4);

                {% if map_id %}
                socket_frame = {
                  type: 'popup',
                  data: {
                      id: current_popup_marker.myCustomID,
                      text: document.getElementById("txtB").value
                  }
                }
                socket.send(JSON.stringify(socket_frame));
                {% endif %}
            }

            //~~~~hooks into the editable module~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~

            //called on object create
            mymap.on('editable:created', function(e) {
                //set new objects id
                e.layer.myCustomID = Math.random().toString(36).substr(2, 9);

                //add popup
                e.layer.bindPopup(html1 + "Input text ..." + html2 + "Input text ..." + html3 + "8" + html4);
                e.layer.on('mouseover', function (e) {
                    this.openPopup();
                });

                //test if marker
                if (e.layer instanceof L.Marker){
                    console.log("Its a Marker, " + e.layer.myCustomID);
                }
                console.log("created");
            });

            //called after object dragged
            mymap.on('editable:dragend', function(e) {
                    console.log("dragged");
            });

            // called while object is being edited
            mymap.on('editable:editing', function(e) {
                //rectangle update
                //rectangle_update(e);

                //polyline_update
                polyline_update(e);

                //polygon
                polygon_update(e);

                //circle
                circle_update(e);

                console.log("editing");
            });

            //called at the end of editing
            mymap.on('editable:drawing:end', function (e) {
                {% if map_id %}

                //rectangle update
                rectangle_update(e);

                //polyline_update
                polyline_update(e);

                //polygon
                polygon_update(e);

                //marker
                marker_update(e);

                //circle
                circle_update(e);

                {% endif %}
                console.log("editable:drawing:end, edited");
            });

            //called while object being dragged
            mymap.on('editable:drag', function (e) {
                {% if map_id %}

                //rectangle update
                rectangle_update(e);

                //polyline_update
                polyline_update(e);

                //polygon
                polygon_update(e);

                //marker
                marker_update(e);

                //circle
                circle_update(e);

                {% endif %}
                console.log("editable:drag");
            });

            //called when object disabled
            mymap.on('editable:disable', function (e) {
                console.log("editable:disable");
            });

            //update polygon
            function polygon_update(e) {
                {% if map_id %}

                //polygon
                if (e.layer instanceof L.Polygon){
                    LatLngs = e.layer.getLatLngs();
                    console.log("Polygon," + e.layer.myCustomID + "," + LatLngs[0]);

                    //convert LatLng data so can use stringify
                    var lldata = [];
                    for(i=0; i<LatLngs[0].length; i++){
                        localdata = new Array(LatLngs[0][i].lat, LatLngs[0][i].lng);
                        lldata.push(localdata);
                    }

                    console.log("JSON " + JSON.stringify(lldata));

                    //craeat JSON package and send
                    socket_frame = {
                      type: 'polygon',
                      data: {
                        id: e.layer.myCustomID,
                        points: JSON.stringify(lldata)
                      }
                    }
                    socket.send(JSON.stringify(socket_frame));
                }
                {% endif %}
            }

            //update rectangle
            function rectangle_update(e) {
                {% if map_id %}

                //polygon
                if (e.layer instanceof L.Rectangle){
                    LatLngs = e.layer.getLatLngs();
                    console.log("Rectangle," + e.layer.myCustomID + "," + LatLngs[0]);

                    //convert LatLng data so can use stringify
                    var lldata = [];
                    for(i=0; i<LatLngs[0].length; i++){
                        localdata = new Array(LatLngs[0][i].lat, LatLngs[0][i].lng);
                        lldata.push(localdata);
                    }

                    console.log("JSON " + JSON.stringify(lldata));

                    //craeat JSON package and send
                    socket_frame = {
                      type: 'polygon',
                      data: {
                        id: e.layer.myCustomID,
                        points: JSON.stringify(lldata)
                      }
                    }
                    socket.send(JSON.stringify(socket_frame));
                }
                {% endif %}
            }

            //update polyline, note data structure difference to polygon which
            //inherits polyline
            function polyline_update(e) {
                {% if map_id %}

                //polygon
                if (e.layer instanceof L.Polygon || e.layer instanceof L.Polyline){
                    LatLngs = e.layer.getLatLngs();
                    console.log("Polyline," + e.layer.myCustomID + "," + LatLngs[0]);

                    //convert LatLng data so can use stringify
                    var lldata = [];
                    for(i=0; i<LatLngs.length; i++){
                        localdata = new Array(LatLngs[i].lat, LatLngs[i].lng);
                        lldata.push(localdata);
                    }

                    console.log("JSON " + JSON.stringify(lldata));

                    //craeat JSON package and send
                    socket_frame = {
                      type: 'polyline',
                      data: {
                        id: e.layer.myCustomID,
                        points: JSON.stringify(lldata)
                      }
                    }
                    socket.send(JSON.stringify(socket_frame));
                }
                {% endif %}
            }

            //update marker
            function marker_update(e) {
                {% if map_id %}
                if (e.layer instanceof L.Marker){
                    console.log("Marker," + e.layer.myCustomID);

                    //craeat JSON package and send
                    socket_frame = {
                      type: 'marker',
                      data: {
                        id: e.layer.myCustomID,
                        latitude: e.layer.getLatLng().lat,
                        longitude: e.layer.getLatLng().lng
                      }
                    }
                    socket.send(JSON.stringify(socket_frame));
                }
                {% endif %}
            }

            //update circle
            function circle_update(e) {
                {% if map_id %}
                if (e.layer instanceof L.Circle){
                    console.log("Circle," + e.layer.myCustomID);

                    //craeat JSON package and send
                    socket_frame = {
                      type: 'circle',
                      data: {
                        id: e.layer.myCustomID,
                        latitude: e.layer.getLatLng().lat,
                        longitude: e.layer.getLatLng().lng,
                        radius: e.layer.getRadius()
                      }
                    }
                    socket.send(JSON.stringify(socket_frame));
                }
                {% endif %}
            }

        //~~~~run once ready~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
        $(document).ready(function () {

            L.tileLayer('https://api.tiles.mapbox.com/v4/{id}/{z}/{x}/{y}.png?access_token=pk.eyJ1IjoibWFwYm94IiwiYSI6ImNpejY4NXVycTA2emYycXBndHRqcmZ3N3gifQ.rJcFIG214AriISLbB6B5aw', {
                maxZoom: 18,
                attribution: 'Map data &copy; <a href="http://openstreetmap.org">OpenStreetMap</a> contributors, ' +
                '<a href="http://creativecommons.org/licenses/by-sa/2.0/">CC-BY-SA</a>, ' +
                'Imagery Â© <a href="http://mapbox.com">Mapbox</a>',
                id: 'mapbox.streets'
            }).addTo(mymap);

            //add annotation layer
            annotationLayer.addTo(mymap);

            // Note that the path doesn't matter right now; any WebSocket
            // connection gets bumped over to WebSocket consumers
            {% if map_id %}
              socket = new WebSocket("ws://" + window.location.host + "/map-socket/{{map_id}}/");
              socket.onmessage = function(e) {
                  //onMapClick(e.data);
                  // alert('received socket');
                  console.log(e)
                  socket_object = JSON.parse(e.data)
                  console.log(socket_object)

                  //update if we are not the annotator #TODO how to enforce? Or many to many?
                  if(document.getElementById("annotate").checked == false){

                      //find if adding or modifying objects
                      var object = null;
                      annotationLayer.eachLayer(function (layer) {
                          // layer.feature is probably defined, to create marker, do something like this
                          if(layer.myCustomID == socket_object.data.id){
                              console.log("Found " + layer.myCustomID);
                              object = layer;
                          }
                      });
                      if(object == null){
                          //need to create object here
                          var newobject = null;
                          console.log("Objects " + socket_object.type);
                          //create
                          if(socket_object.type == 'marker'){
                              newobject = L.marker([socket_object.data.latitude,socket_object.data.longitude]);
                          }else if(socket_object.type == 'polygon' || socket_object.type == 'polyline'){
                              console.log("Points "+socket_object.data.points);
                              var points = JSON.parse(socket_object.data.points);
                              console.log("Points " + points.length + "," + points[0][0]);
                              if(socket_object.type == 'polyline'){
                                  newobject = L.polyline(points);
                              }else{
                                  newobject = L.polygon(points);
                              }
                          }else if(socket_object.type == 'circle'){
                              newobject = L.circle([socket_object.data.latitude,socket_object.data.longitude], socket_object.data.radius);
                          }

                          //set id and add to layer
                          if(newobject != null){
                              newobject.myCustomID = socket_object.data.id;
                              annotationLayer.addLayer(newobject);
                              newobject.bindPopup("Undefined");
                              newobject.on('mouseover', function (e) {
                                  this.openPopup();
                              });
                          }
                      }else{
                          //modify
                          if(socket_object.type == 'marker'){
                              object.setLatLng([socket_object.data.latitude,socket_object.data.longitude]);
                          }else if(socket_object.type == 'polygon' || socket_object.type == 'polyline'){
                              var points = JSON.parse(socket_object.data.points);
                              object.setLatLngs(points);
                          }else if(socket_object.type == 'circle'){
                              object.setLatLng([socket_object.data.latitude,socket_object.data.longitude]);
                              object.setRadius(socket_object.data.radius);
                          }else if(socket_object.type == 'popup'){
                              object.setPopupContent(socket_object.data.text);
                          }
                      }

                  }
              }
              socket.onopen = function() {
                  socket.send("joining map annotation for map {{map_id}}");
              }
              // Call onopen directly if socket is already open
              if (socket.readyState == WebSocket.OPEN) socket.onopen();

              {% endif %}

            get_layers_from_server();

        });

        /*
        Ajax call to the server. Returns JSON with layers in it.
        TODO: Will need to update url to GeoServer eventually
         */
        function get_layers_from_server() {
            $.ajax({
                type: "GET",
                url: "/api/my_layers/",
                data: {},
                dataType: "json",
                success: function (result) {
                    console.log("GIS LAYERS -- SUCCESS!");
                    console.log(result.layers);
                    process_layers(result.layers);
                },
                error: function (result) {
                    console.log("ERROR:", result)
                }
            });
        }

        /*
        Function to pull the layer groups out and call the appropriate function
        for layer group or layer to be added to the menu.
         */
        function process_layers(layers) {

            layers.forEach(function (item) {
                // Get layer groups
                layer_groups.push(item.group);

            });
            layer_groups = layer_groups.unique();
            console.log(layer_groups);

            layer_groups.forEach(function (group) {
                // Add the layer category group to the menu
               add_layer_group_to_menu(group);

               // For each layer in the layers list, if the group matches the current group
                // add that layer to the unordered list
               layers.forEach(function (layer){
                  if(layer.group == group) {
                      var ul_object = '#' + camelize(layer.group.toLowerCase());
                      add_layer_to_menu(layer, ul_object)
                  }
               });
            });

        }

        /*
        The base #layerGroup template is hidden by default. Cloning the template and
        it's children allows us to edit the attributes of each #layerGroup individually.

        Attributes are formatted in the exact same way as Kristina's mockups to retain functionality.
        Could likely be simplified, but camelizing the lowercase strings wasn't too difficult.
         */
        function add_layer_group_to_menu(layerGroup) {
            var group_template = $('#layerGroup').clone(true);
            $(group_template).find('span').html(layerGroup);
            $(group_template).find('a').attr('href', '#' +
                camelize(layerGroup.toLowerCase())).attr('aria-controls', camelize(layerGroup.toLowerCase()));
            $(group_template).find('ul').attr('id', camelize(layerGroup.toLowerCase()));
            $(group_template).removeClass('hidden');
            $("#gisLayers").append(group_template);
        }

        /*
        Add the individual layers to the menu under the appropriate layer category group.
        Params: layer - the layer to add to the menu (complete layer object)
                ul_id - the id of the unordered list in which to append the layer.
         */
        function add_layer_to_menu(layer, ul_id) {
            // Create the HTML <li> for each layer and append to the <ul>
            var layer_html = '<li><input id="' + $.trim(layer.id) + '" type="checkbox"> ' + $.trim(layer.name) + '</li>';
            $(ul_id).append(layer_html);
            layer.maplayer = L.tileLayer.wms(layer.layer_link, {layers: layer.layer, transparent: true, format: 'image/png'});
            layer_list.push(layer);

            $('#' + $.trim(layer.id)).click(function () {
                {#var link = layer.layer_link;#}
                if ($(this).is(':checked')) {
                    for(var i=0; i<layer_list.length; i++) {
                        if (layer_list[i].id == this.id){
                            console.log("found matching layer: " + this.id);
                            layer_list[i].maplayer.addTo(mymap);
                        }
                    }
                } else {
                    for(var i=0; i<layer_list.length; i++) {
                        if (layer_list[i].id == this.id){
                            console.log("found matching layer: " + this.id);
                            mymap.removeLayer(layer_list[i].maplayer);
                        }
                    }
                }
            });
        }

      $(function () {
        $('.beta-feature-not-available').tooltip(
          {
            title: "Feature not available at this time",
            placement: "top",
            width: '300px'
          });
      });

      //~~~~map annotation section~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
      //toggle layer
      function toggle_annotation_layer(onOff) {

          if(onOff){
              annotationLayer.addTo(mymap);
          }else{
              document.getElementById("annotate").checked = false;
              toggle_annotate(false);
              mymap.removeLayer(annotationLayer);
          }
          console.log(onOff);
      }

      //toggle annotate controls
      function toggle_annotate(onOff) {

          if(onOff){
              mymap.addControl(marker_control);
              mymap.addControl(line_control);
              mymap.addControl(polygon_control);
              mymap.addControl(rectangle_control);
              mymap.addControl(circle_control);
          }else{
              mymap.removeControl(marker_control);
              mymap.removeControl(line_control);
              mymap.removeControl(polygon_control);
              mymap.removeControl(rectangle_control);
              mymap.removeControl(circle_control);
          }
          console.log(onOff);
      }

    </script>
{% endblock extra_script %}
