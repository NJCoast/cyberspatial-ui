{% extends 'site_base.html' %}
{% load i18n %}
{% load staticfiles %}
{% load base_tags %}

{% block body_class %}home{% endblock %}

{% block extra_head %}
    <!-- Load Leaflet from CDN -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.2.0/dist/leaflet.css"
          integrity="sha512-M2wvCLH6DSRazYeZRIm1JnYyh22purTM+FDB5CsyxtQJYeKq83arPe5wgbNmcFXGqiSH2XR8dT/fJISVA1r/zQ=="
          crossorigin=""/>
    <script src="https://unpkg.com/leaflet@1.2.0/dist/leaflet.js"
            integrity="sha512-lInM/apFSqyy1o6s89K4iQUKg6ppXEgsVxT35HbzUupEVRh2Eu9Wdl4tHj7dZO0s1uvplcYGmt3498TtHq+log=="
            crossorigin=""></script>


    <!-- Load Esri Leaflet from CDN -->
    <script src="https://unpkg.com/esri-leaflet@2.1.1/dist/esri-leaflet.js"
            integrity="sha512-ECQqaYZke9cSdqlFG08zSkudgrdF6I1d8ViSa7I3VIszJyVqw4ng1G8sehEXlumdMnFYfzY0tMgdQa4WCs9IUw=="
            crossorigin=""></script>

    <script src="https://npmcdn.com/leaflet.path.drag/src/Path.Drag.js"></script>

    <!-- Load Leaflet Editable code -->
    <script src="{% static "js/Leaflet.Editable.js" %}"></script>-->

    <!-- load mods to leaflet for rectangular popups/map icons -->
    <link rel="stylesheet" type="text/css" href="{% static "css/crc_leaflet.css" %}" media="screen" />
    <link rel="stylesheet" type="text/css" href="{% static "css/fontawesome-all.min.css" %}" media="screen" />

{% endblock extra_head %}


{% block middle %}

    <div class="jumbotron njcoast-image slimmer"></div>

    <div class="container">
        <div class="page-header map-header">
            <a href="/expert/" class="btn btn-primary btn-md pull-right">Run New Simulation</a>
            <h3>Explore Simulations</h3>
        </div>
        <div class="row">
            <!-- #TODO imlement this column, set to hidden -->
            <div class="col-md-3 hidden">
                <div class="selections">
                    Your selections
                    <a href="" id="clear-search" class="pull-right">Clear</a>
                </div>
                <nav class="filter">

                    <h4><a href="#" class="toggle toggle-nav"><i class="fa fa-chevron-down"></i>Text</a></h4>
                    <ul class="nav open" id="text">
                        <li>
                            <div class="input-group">
                                <input name="text_search_input" id="text_search_input" ng-model="text_query" type="text" placeholder="Search by text" class="form-control">
                                <span class="input-group-btn">
                                    <button class="btn btn-primary" type="submit" id="text_search_btn"><i class="fa fa-search"></i></button>
                                </span>
                            </div>
                        </li>
                    </ul>
                </nav>

                <div id="slide-pane">


                    <nav class="filter">
                        <h4><a href="#" class="toggle toggle-nav"><i class="fa fa-chevron-down"></i>Categories</a></h4>
                        <ul class="nav open" id="categories">

                            <li>
                                <a>Archived Storms
                                    <span class="badge pull-right">56</span>
                                </a>
                            </li>
                            <li>
                                <a class="active">My What-if Scenarios
                                    <span class="badge pull-right">2</span>
                                </a>
                            </li>
                            <li>
                                <a>Shared with Me
                                    <span class="badge pull-right">6</span>
                                </a>
                            </li>
                            <li>
                                <a>
                                    <div class="h-badge">H</div>Hurricanes
                                    <span id="hurricanes" class="badge pull-right">38</span>
                                </a>
                            </li>
                            <li>
                                <a>
                                    <div class="n-badge">N</div>Nor'easters
                                    <span id="noreasters" class="badge pull-right">18</span>
                                </a>
                            </li>
                        </ul>
                    </nav>



                    <nav class="filter">
                        <h4><a href="#" class="toggle toggle-nav"><i class="fa fa-chevron-down"></i>Date</a></h4>
                        <ul class="nav open" id="date_start">
                            <label>Date begins after:</label>
                            <li><input value="yyyy-mm-dd" data-date-format="YYYY-MM-DD" type="text" class="datepicker" placeholder="yyyy-mm-dd" ng-model="date_query.date__gte" /></li>
                        </ul>
                        <ul class="nav open" id="date_end">
                            <label>Date ends before:</label>
                            <li><input value="yyyy-mm-dd" data-date-format="YYYY-MM-DD" type="text" class="datepicker" placeholder="yyyy-mm-dd" ng-model="date_query.date__lte" /></li>
                        </ul>
                    </nav>


                </div>
            </div>
            <div class="col-md-9">
                <div class="row" style="margin-top:1em">
                    <div class="col-md-3">
                        <span>Total: </span>
                        <span id="total" ng-bind="total_counts">4</span>
                    </div>

                    <div class="col-md-9">
                        <ul class="list-inline pull-left" id="sort">
                            <li><a data-value="-date" data-filter="order_by" class="selected" ng-click="single_choice_listener($event)">Most recent</a></li>
                            <!-- <li><a data-value="date" data-filter="order_by" ng-click="single_choice_listener($event)">Less recent</a></li>
                            <li><a data-value="title" data-filter="order_by" ng-click="single_choice_listener($event)">A - Z</a></li>
                            <li><a data-value="-title" data-filter="order_by" ng-click="single_choice_listener($event)">Z - A</a></li>-->
                            <!--<li><a data-value="-popular_count" data-filter="order_by" ng-click="single_choice_listener($event)">Most popular</a></li>-->
                        </ul>
                    </div>
                </div>
                <ul id="dashboard-list" class="dashboard-list">
                    {% for simulation in simulations_for_user %}
                    <li {% if forloop.counter > 4 %}class="hidden"{% endif %}>
                        <article>
                            <div class="row items-list">
                                <div class="col-xs-12 item-info shp-info">
                                    <h4><div id="badge-{{ forloop.counter }}" class="h-badge what-if">H</div><span id="storm-{{ forloop.counter }}">{{ simulation.data.storm_type }} Run</span></h4>
                                    <p>{{ simulation.description }} <span class="owner">by <a href="">{{ simulation.user_name }}</a></span></p>
                                    <p class="shp-scenario"><span>Sea Level Rise:</span> {{ simulation.data.SLR }}, <span>Coastal Protection:</span> {{ simulation.data.protection }}, <span>Tides:</span> {{ simulation.data.tide_td }}, <span>Analysis type:</span> {{ simulation.data.analysis }}, <span>Simulation id:</span> {{ simulation.sim_id }}</p>
                                    <br/>
                                    <p class="actions">
                                        <table style="width: 100%;">
                                            <tr>
                                                <td>
                                                    <i class="fa fa-calendar-o"></i>{{ simulation.modified }} |
                                                </td>
                                                <td>
                                                    <div class="dropup show pull-right">
                                                        <button class="dropdown-toggle" style="margin-top: 5px" id="dropdownMenuAddToMap_{{ forloop.counter }}" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
                                                            Add Results to Map ... <i href="#"  class="fa fa-caret-up" style="margin-left: 10px" aria-hidden="true"></i>
                                                        </button>
                                                        <div class="dropdown-menu" aria-labelledby="dropdownMenuAddToMap_{{ forloop.counter }}">
                                                            {% for map in maps_for_user %}
                                                            <a class="dropdown-item" name="{{ map.id }}" onclick='add_expert_to_map(this, "{{ simulation.sim_id }}");'>{{ map.name }}</a>
                                                            <div class="dropdown-divider"></div>
                                                            {% endfor %}
                                                        </div>
                                                    </div>
                                                </td>
                                            </tr>
                                        </table>
                                    </p>
                                </div>
                            </div>
                        </article>
                    </li>
                    {% endfor %}
                </ul>

                <div class="row" style="margin-bottom: 300px">
                    <nav>
                        <ul class="pagination pull-right">
                            <li ng-click="paginate_down()"><a id="pageBackwards" href="#"><strong><i class="fa fa-angle-left"></i></strong></a></li>
                            <li><span>page <span id="page" ng-model="page" ng-bind="page">1</span> of <span id="pagetotal" ng-bind="numpages">1</span></span>
                            </li>
                            <li ng-click="paginate_up()"><a id="pageForward" href="#"><strong><i class="fa fa-angle-right"></i></strong></a></li>
                        </ul>
                    </nav>
                </div>
            </div>
        </div>
    </div>

{% endblock middle %}

{% block extra_script %}
<script type=text/javascript>
//total sims
var counter = 1;
var page = 1;

var shownItems = 0;

$("#pageBackwards").on("click", function() {
    var items = $("#dashboard-list li");
    //var shownItems = items.filter(":visible").length;
    console.log("Clicked "+items.length+","+shownItems);

    //remove old ones
    items.slice(shownItems, shownItems + 4).addClass("hidden");

    //add new ones
    shownItems -= 4;
    if(shownItems < 0){
        shownItems = 0;
    }else{
        page--;
    }
    items.slice(shownItems, shownItems + 4).removeClass("hidden");

    //update page
    document.getElementById('page').innerHTML = page;
});

$("#pageForward").on("click", function() {
    var items = $("#dashboard-list li");
    //var shownItems = items.filter(":visible").length;
    console.log("Clicked "+items.length+","+shownItems);

    //remove old ones
    items.slice(shownItems, shownItems + 4).addClass("hidden");

    //add new ones
    oldshownItems = shownItems;

    if((shownItems + 8) > counter){
        shownItems = counter - counter%4;
    }else{
        shownItems += 4;
    }

    if(oldshownItems != shownItems){
        page++;
    }
    items.slice(shownItems, shownItems + 4).removeClass("hidden");

    //update page
    document.getElementById('page').innerHTML = page;
});

//~~~~run once ready~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
$(document).ready(function () {

    //loop until end of data list
    hurricanes = 0;
    noreasters = 0;

    do{
        more_elmts = document.getElementById('badge-'+counter);

        //if exists and checked then save
        if(more_elmts){
            //change badge if Nor'easter
            if(document.getElementById('storm-'+counter).innerHTML.indexOf("Nor'easter") >= 0){
                more_elmts.innerHTML = "N";
                more_elmts.classList.remove("h-badge");
                more_elmts.classList.add("n-badge");
                noreasters++;
            }else{
                hurricanes++;
            }

            //increment
            counter++;
        }

    }while(more_elmts)

    //fix last increment
    counter--;

    //update total
    document.getElementById('total').innerHTML = counter;

    //update hurricanes
    document.getElementById('hurricanes').innerHTML = hurricanes;

    //update total
    document.getElementById('noreasters').innerHTML = noreasters;

    //update total
    document.getElementById('pagetotal').innerHTML = Math.ceil(counter / 4);

});

//add the current simulation to a map
function add_expert_to_map(object, sim_id){
    //save map and sim data
    map_data = {
        'sim_id': sim_id,
    };

    console.log("Map clicked "+JSON.stringify(map_data)+","+object.innerHTML);

    //Do ajax
    $.ajax({
        type: "POST",
        url: "/map/" + object.name + "/settings/",
        data: {
            'sim_id': sim_id,
            'action': 'add_simulation',
            'add_layer': sim_id + "_surge"
        },
        dataType: "json",
        success: function(result) {
            console.log("SAVING TO MAP -- SUCCESS!" + result.saved);
            //now auto save so dont flag
            //$.notify("Simulation saved to map " + object.innerHTML, "success");

            //jump to page
            //window.location.href = "/map/" + object.name + "/";
        },
        error: function(result) {
            console.log("ERROR:", result)
            //$.notify("Error saving simulation to map", "error");
        }
    });
}

</script>
{% endblock extra_script %}
